<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Ù…Ù†Ø¸ÙˆÙ…Ø© ÙÙˆØ§Ù„ Ù…Ø±ÙˆÙ‡ Ø§Ù„ÙÙˆØ±ÙŠØ©</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        body { font-family: 'Tajawal', sans-serif; background: #f1f5f9; overflow-x: hidden; }
        .tab-section { display: none; transition: 0.3s; }
        .tab-section.active { display: block; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }
        
        .glass { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.2); }
        .order-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .order-new { border-right: 5px solid #10b981; animation: pulseGlow 2s infinite; }
        @keyframes pulseGlow { 0% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0.4); } 70% { box-shadow: 0 0 0 15px rgba(16, 185, 129, 0); } 100% { box-shadow: 0 0 0 0 rgba(16, 185, 129, 0); } }
        
        .step-active { background: #10b981 !important; color: white !important; box-shadow: 0 0 15px #10b981; }
        .bottom-nav { position: fixed; bottom: 20px; left: 20px; right: 20px; height: 75px; z-index: 1000; display: flex; justify-content: space-around; align-items: center; border-radius: 25px; box-shadow: 0 15px 35px rgba(0,0,0,0.1); }
    </style>
</head>
<body class="pb-32">

    <section id="client-view" class="tab-section active p-6">
        <header class="mb-8">
            <h1 class="text-3xl font-black text-emerald-900 italic">Ù…Ø±ÙˆÙ‡ ØºØ²ÙˆØ§Ù†ÙŠ â™¨ï¸</h1>
            <p class="text-sm font-bold text-slate-400">Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¢Ù†.. ÙŠØµÙ„Ùƒ Ø³Ø§Ø®Ù†Ø§Ù‹ ÙÙˆØ±Ø§Ù‹</p>
        </header>

        <div id="menu-list" class="grid grid-cols-2 gap-4">
            </div>
    </section>

    <section id="track-view" class="tab-section p-6">
        <h2 class="text-2xl font-black mb-6">ØªØªØ¨Ø¹ Ø§Ù„Ø·Ù„Ø¨ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±</h2>
        <div id="track-container" class="space-y-6">
            <div id="track-empty" class="text-center py-20 opacity-30">
                <i class="fas fa-satellite-dish text-6xl mb-4"></i>
                <p class="font-bold">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø·Ù„Ø¨ Ù†Ø´Ø· Ø­Ø§Ù„ÙŠØ§Ù‹</p>
            </div>
            
            <div id="track-card" class="hidden glass p-8 rounded-[40px] shadow-xl">
                <div class="flex justify-between items-center mb-10">
                    <span id="order-id-display" class="bg-slate-100 px-4 py-2 rounded-xl text-xs font-black">#----</span>
                    <span class="text-emerald-600 font-black animate-pulse text-xs">ØªØ­Ø¯ÙŠØ« ÙÙˆØ±ÙŠ <i class="fas fa-circle text-[8px]"></i></span>
                </div>
                
                <div class="space-y-12 relative">
                    <div class="absolute right-[19px] top-0 bottom-0 w-1 bg-slate-100"></div>
                    <div class="flex items-center gap-6 relative z-10">
                        <div id="s1" class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center transition-all"><i class="fas fa-receipt"></i></div>
                        <div><p class="font-black">ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</p></div>
                    </div>
                    <div class="flex items-center gap-6 relative z-10">
                        <div id="s2" class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center transition-all"><i class="fas fa-fire-burner"></i></div>
                        <div><p class="font-black">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±</p></div>
                    </div>
                    <div class="flex items-center gap-6 relative z-10">
                        <div id="s3" class="w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center transition-all"><i class="fas fa-truck-fast"></i></div>
                        <div><p class="font-black">Ø®Ø±Ø¬ Ù„Ù„ØªÙˆØµÙŠÙ„</p></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <section id="cashier-view" class="tab-section p-6">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-2xl font-black">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… ğŸ–¥ï¸</h2>
            <div class="bg-white px-4 py-2 rounded-2xl shadow-sm text-xs font-black">Ø§Ù„Ù…Ø¨ÙŠØ¹Ø§Øª: <span id="sales-today" class="text-emerald-600">0</span> ï·¼</div>
        </div>
        <div id="cashier-orders" class="space-y-4">
            </div>
    </section>

    <section id="driver-view" class="tab-section p-6">
        <h2 class="text-2xl font-black mb-8">Ø·Ù„Ø¨Ø§Øª Ø§Ù„ØªÙˆØµÙŠÙ„ ğŸï¸</h2>
        <div id="driver-orders" class="space-y-4">
            </div>
    </section>

    <nav class="bottom-nav glass">
        <button onclick="showTab('client')" class="flex flex-col items-center gap-1 text-emerald-600"><i class="fas fa-store text-xl"></i><span class="text-[10px] font-black">Ø§Ù„Ù…ØªØ¬Ø±</span></button>
        <button onclick="showTab('track')" class="flex flex-col items-center gap-1 text-slate-400 relative"><i class="fas fa-map-location-dot text-xl"></i><span class="text-[10px] font-black">ØªØªØ¨Ø¹</span><div id="track-dot" class="hidden absolute top-0 right-0 w-2 h-2 bg-red-500 rounded-full"></div></button>
        <button onclick="showTab('cashier')" class="flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-terminal text-xl"></i><span class="text-[10px] font-black">Ø§Ù„ÙƒØ§Ø´ÙŠØ±</span></button>
        <button onclick="showTab('driver')" class="flex flex-col items-center gap-1 text-slate-400"><i class="fas fa-biking text-xl"></i><span class="text-[10px] font-black">Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨</span></button>
    </nav>

    <div id="cart-bar" class="fixed bottom-28 left-6 right-6 h-16 bg-emerald-600 rounded-2xl shadow-2xl flex items-center justify-between px-6 text-white hidden transform scale-0 transition-transform duration-300">
        <div class="flex items-center gap-3">
            <span id="cart-items-count" class="bg-white text-emerald-600 w-6 h-6 rounded-full flex items-center justify-center font-black text-xs">0</span>
            <span id="cart-items-total" class="font-black">0 ï·¼</span>
        </div>
        <button onclick="checkout()" class="font-black italic">ØªØ£ÙƒÙŠØ¯ ÙÙˆØ±ÙŠ <i class="fas fa-bolt ml-1"></i></button>
    </div>

    <script>
        // --- ØªÙ‡ÙŠØ¦Ø© Firebase ---
        const firebaseConfig = {
            apiKey: "AIzaSyCcQkEMeeoIHbj_7bbU1TnidZJJOdjAx8s",
            authDomain: "fawal-c9530.firebaseapp.com",
            projectId: "fawal-c9530",
            storageBucket: "fawal-c9530.firebasestorage.app",
            messagingSenderId: "5341806694",
            appId: "1:5341806694:web:746e207ad783dbaac26da7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ÙŠÙˆ Ù…Ø¹ ØµÙˆØ± Ø­Ù‚ÙŠÙ‚ÙŠØ©
        const MENU = [
            {id:1, n:"ÙÙˆÙ„ Ø¬Ø±Ø© Ø¨Ø§Ù„Ø³Ù…Ù†", p:8, img:"https://images.unsplash.com/photo-1541518763669-27fef04b14ea?w=300"},
            {id:2, n:"Ø¹Ø±ÙŠÙƒØ© Ù…Ù„ÙƒÙŠ ÙØ§Ø®Ø±Ø©", p:22, img:"https://images.unsplash.com/photo-1589113103503-49ef83d89e7c?w=300"},
            {id:3, n:"Ù…Ø¹ØµÙˆØ¨ Ù‚Ø´Ø·Ø© Ø¹Ø³Ù„", p:15, img:"https://images.unsplash.com/photo-1504674900247-0877df9cc836?w=300"},
            {id:4, n:"Ù…Ø·Ø¨Ù‚ Ø®Ø¶Ø§Ø±", p:7, img:"https://images.unsplash.com/photo-1601050690597-df0568f70950?w=300"}
        ];

        let cart = [];
        let currentOrderID = localStorage.getItem('order_id');

        // ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„ÙÙˆØ±ÙŠ
        window.onload = () => {
            renderMenu();
            listenToOrders();
            if(currentOrderID) trackOrder(currentOrderID);
        };

        function renderMenu() {
            const list = document.getElementById('menu-list');
            list.innerHTML = MENU.map(i => `
                <div class="bg-white rounded-3xl overflow-hidden shadow-sm active:scale-95 transition" onclick="addToCart(${i.id})">
                    <img src="${i.img}" class="h-28 w-full object-cover">
                    <div class="p-3">
                        <h3 class="font-black text-xs text-slate-800">${i.n}</h3>
                        <p class="text-emerald-600 font-black mt-1">${i.p} ï·¼</p>
                    </div>
                </div>
            `).join('');
        }

        function addToCart(id) {
            const item = MENU.find(x => x.id === id);
            cart.push(item);
            const bar = document.getElementById('cart-bar');
            bar.classList.remove('hidden');
            setTimeout(() => bar.classList.add('scale-100'), 10);
            document.getElementById('cart-items-count').innerText = cart.length;
            document.getElementById('cart-items-total').innerText = cart.reduce((s,i)=>s+i.p,0) + " ï·¼";
            if(navigator.vibrate) navigator.vibrate(50);
        }

        async function checkout() {
            const order = {
                items: cart,
                total: cart.reduce((s,i)=>s+i.p,0),
                status: 'received',
                time: firebase.firestore.FieldValue.serverTimestamp()
            };
            const doc = await db.collection("orders").add(order);
            currentOrderID = doc.id;
            localStorage.setItem('order_id', doc.id);
            cart = [];
            document.getElementById('cart-bar').classList.replace('scale-100', 'scale-0');
            showTab('track');
            trackOrder(doc.id);
        }

        function trackOrder(id) {
            document.getElementById('track-empty').classList.add('hidden');
            document.getElementById('track-card').classList.remove('hidden');
            document.getElementById('track-dot').classList.remove('hidden');

            db.collection("orders").doc(id).onSnapshot(doc => {
                const data = doc.data();
                document.getElementById('order-id-display').innerText = "#" + id.slice(-5);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø³ØªÙŠØ¨Ø³ ÙÙˆØ±Ø§Ù‹
                document.getElementById('s1').className = "w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center step-active";
                document.getElementById('s2').className = (data.status==='preparing' || data.status==='on_way') ? "w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center step-active" : "w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center";
                document.getElementById('s3').className = (data.status==='on_way') ? "w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center step-active" : "w-10 h-10 rounded-full bg-slate-200 flex items-center justify-center";
                
                if(data.status === 'delivered') alert("ØªÙ… ØªÙˆØµÙŠÙ„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­! ğŸ˜");
            });
        }

        function listenToOrders() {
            db.collection("orders").orderBy("time", "desc").onSnapshot(snap => {
                const cashierList = document.getElementById('cashier-orders');
                const driverList = document.getElementById('driver-orders');
                let sales = 0;

                cashierList.innerHTML = "";
                driverList.innerHTML = "";

                snap.forEach(doc => {
                    const o = doc.data();
                    sales += o.total;

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„ÙƒØ§Ø´ÙŠØ±
                    cashierList.innerHTML += `
                        <div class="bg-white p-5 rounded-3xl shadow-sm order-card ${o.status==='received'?'order-new':''}">
                            <div class="flex justify-between mb-2">
                                <span class="font-black">#${doc.id.slice(-5)}</span>
                                <span class="text-[10px] font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full">${o.status}</span>
                            </div>
                            <p class="text-xs text-slate-500 mb-4">${o.items.map(i=>i.n).join(' + ')}</p>
                            <div class="flex gap-2">
                                <button onclick="updateStatus('${doc.id}', 'preparing')" class="flex-1 bg-slate-800 text-white py-2 rounded-xl text-[10px] font-black">ØªØ­Ø¶ÙŠØ±</button>
                                <button onclick="updateStatus('${doc.id}', 'on_way')" class="flex-1 bg-emerald-600 text-white py-2 rounded-xl text-[10px] font-black">ØªØ³Ù„ÙŠÙ… Ù„Ù„Ù…Ù†Ø¯ÙˆØ¨</button>
                            </div>
                        </div>
                    `;

                    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†Ø¯ÙˆØ¨
                    if(o.status === 'on_way') {
                        driverList.innerHTML += `
                            <div class="bg-white p-6 rounded-3xl shadow-lg border-2 border-emerald-500">
                                <p class="font-black mb-2 italic">Ø·Ù„Ø¨ Ø¬Ø§Ù‡Ø² Ù„Ù„ØªÙˆØµÙŠÙ„</p>
                                <p class="text-xs text-slate-400 mb-4">Ø§Ù„Ù…Ø¨Ù„Øº Ù„Ù„ØªØ­ØµÙŠÙ„: ${o.total} ï·¼</p>
                                <button onclick="updateStatus('${doc.id}', 'delivered')" class="w-full bg-emerald-600 text-white py-4 rounded-2xl font-black">ØªÙ… Ø§Ù„ØªØ³Ù„ÙŠÙ… âœ…</button>
                            </div>
                        `;
                    }
                });
                document.getElementById('sales-today').innerText = sales;
            });
        }

        async function updateStatus(id, s) { await db.collection("orders").doc(id).update({status: s}); }

        function showTab(view) {
            document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
            document.getElementById(view + '-view').classList.add('active');
            
            // ØªØ­Ø¯ÙŠØ« Ø£Ù„ÙˆØ§Ù† Ø§Ù„Ø£Ø²Ø±Ø§Ø±
            document.querySelectorAll('nav button').forEach(b => b.classList.replace('text-emerald-600', 'text-slate-400'));
            event.currentTarget.classList.replace('text-slate-400', 'text-emerald-600');
            if(view === 'track') document.getElementById('track-dot').classList.add('hidden');
        }
    </script>
</body>
</html>
