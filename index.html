<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ÙÙˆØ§Ù„ Ù…Ø±ÙˆÙ‡ | 2030</title>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        :root { --p: #0f172a; --a: #3b82f6; --bg: #f8fafc; }
        body { font-family: 'Tajawal', sans-serif; background: var(--bg); color: var(--p); overflow-x: hidden; }
        .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.3); }
        .item-card { background: white; border-radius: 30px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); border: 1px solid #f1f5f9; }
        .item-card:active { transform: scale(0.96); }
        .status-pill { padding: 4px 12px; border-radius: 50px; font-size: 10px; font-weight: 900; }
        .step-active { color: var(--a); transform: scale(1.1); font-weight: 900; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
    </style>
</head>
<body class="pb-32">

    <div id="toast" class="fixed top-8 left-6 right-6 z-[10000] glass p-4 rounded-3xl shadow-2xl transition-all translate-y-[-150%] opacity-0 flex items-center gap-4">
        <div id="toastIcon" class="w-10 h-10 rounded-2xl flex items-center justify-center text-white"></div>
        <p id="toastMsg" class="font-bold text-sm"></p>
    </div>

    <header class="p-6 sticky top-0 z-[1000] glass rounded-b-[40px] shadow-sm">
        <div class="flex justify-between items-center mb-6">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter">ÙÙˆØ§Ù„ Ù…Ø±ÙˆÙ‡</h1>
                <p class="text-[10px] font-black opacity-40 uppercase">Premium Dining Experience</p>
            </div>
            <button onclick="showTracker()" class="w-12 h-12 bg-slate-900 text-white rounded-2xl flex items-center justify-center shadow-lg">
                <i class="fa-solid fa-clock-rotate-left"></i>
            </button>
        </div>
        <div id="tabs" class="flex gap-3 overflow-x-auto no-scrollbar"></div>
    </header>

    <main class="p-6 max-w-lg mx-auto space-y-6">
        <div id="activeOrderDisplay" class="hidden glass p-6 rounded-[35px] border-2 border-blue-100 shadow-xl">
            <div class="flex justify-between items-center mb-4">
                <span class="font-black text-blue-900">ØªØªØ¨Ø¹ Ø·Ù„Ø¨Ùƒ Ø§Ù„Ø¢Ù†</span>
                <span id="orderIdTag" class="text-[10px] bg-blue-600 text-white px-3 py-1 rounded-full font-bold">#0000</span>
            </div>
            <div class="flex justify-between items-center text-[10px] text-slate-400 font-black relative">
                <div class="absolute h-[2px] bg-slate-100 w-full top-3 -z-10"></div>
                <div id="step-sent" class="flex flex-col items-center gap-1 bg-white p-1 rounded-lg">
                    <i class="fa-solid fa-paper-plane text-base"></i><span>ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„</span>
                </div>
                <div id="step-preparing" class="flex flex-col items-center gap-1 bg-white p-1 rounded-lg">
                    <i class="fa-solid fa-fire-burner text-base"></i><span>ÙŠØªÙ… Ø§Ù„ØªØ­Ø¶ÙŠØ±</span>
                </div>
                <div id="step-ready" class="flex flex-col items-center gap-1 bg-white p-1 rounded-lg">
                    <i class="fa-solid fa-bag-shopping text-base"></i><span>Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…</span>
                </div>
            </div>
        </div>

        <div id="grid" class="space-y-4"></div>
    </main>

    <div id="cartBar" onclick="openCart()" class="fixed bottom-10 left-6 right-6 h-20 bg-slate-900 text-white rounded-[30px] shadow-2xl flex items-center justify-between px-6 translate-y-32 opacity-0 transition-all duration-500 z-[2000]">
        <div class="flex items-center gap-4">
            <div class="relative">
                <div class="w-12 h-12 bg-blue-600 rounded-2xl flex items-center justify-center text-xl"><i class="fa-solid fa-cart-shopping"></i></div>
                <span id="cartCount" class="absolute -top-2 -right-2 bg-red-500 w-6 h-6 rounded-full border-2 border-slate-900 flex items-center justify-center text-[10px] font-black">0</span>
            </div>
            <div class="text-xl font-black text-blue-400" id="cartTotal">0ï·¼</div>
        </div>
        <button class="bg-white/10 px-6 py-2 rounded-xl font-black text-sm">Ù…Ø±Ø§Ø¬Ø¹Ø© Ø§Ù„Ø·Ù„Ø¨</button>
    </div>

    <div id="modal" class="fixed inset-0 z-[5000] hidden glass items-end justify-center">
        <div id="modalBox" class="bg-white w-full max-w-lg rounded-t-[50px] p-8 translate-y-full transition-all duration-500 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div id="modalContent"></div>
        </div>
    </div>

    <script>
        // ØªÙƒÙˆÙŠÙ† Firebase (Ø§Ø³ØªØ®Ø¯Ù… Ù†ÙØ³ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ)
        const firebaseConfig = {
            apiKey: "AIzaSyCcQkEMeeoIHbj_7bbU1TnidZJJOdjAx8s",
            authDomain: "fawal-c9530.firebaseapp.com",
            projectId: "fawal-c9530",
            storageBucket: "fawal-c9530.firebasestorage.app",
            messagingSenderId: "5341806694",
            appId: "1:5341806694:web:746e207ad783dbaac26da7"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙƒØ§Ù…Ù„Ø© Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£ØµÙ†Ø§Ù
        const MENU = {
            "ÙØ·ÙˆØ± Ù…Ø±ÙˆÙ‡": [
                {id:1, n:"ÙÙˆÙ„ Ø³Ø§Ø¯Ø©", s:{s:3, m:4, l:5, loc:6}},
                {id:2, n:"ÙÙˆÙ„ Ù…Ø´ÙƒÙ„", s:{s:4, m:5, l:6, loc:7}},
                {id:13, n:"ØªÙˆÙ†Ø© ÙØ§Ø®Ø±Ø©", s:{s:10, m:11, l:12, loc:10}},
                {id:14, n:"Ø´ÙƒØ´ÙˆÙƒØ© Ø¹Ø¯Ù†ÙŠ", s:{s:6, m:7, l:8, loc:7}},
                {id:22, n:"ÙƒÙ…ÙˆÙ†ÙŠØ©", s:{s:10, m:12, l:15, loc:11}}
            ],
            "Ø§Ù„Ù…Ø·Ø¨Ù‚": [
                {id:23, n:"Ù…Ø·Ø¨Ù‚ Ø®Ø¶Ø§Ø±", p:5},
                {id:24, n:"Ù…Ø·Ø¨Ù‚ Ù…Ø§Ù„Ø­", p:5},
                {id:33, n:"Ù…Ø·Ø¨Ù‚ Ù†ÙˆØªÙŠÙ„Ø§", p:7}
            ],
            "Ø§Ù„Ù…Ø¹ØµÙˆØ¨ ÙˆØ§Ù„Ø¹Ø±ÙŠÙƒØ©": [
                {id:34, n:"Ø¹Ø±ÙŠÙƒØ© Ù‚Ø´Ø·Ø© Ø¹Ø³Ù„", p:12},
                {id:36, n:"Ù…Ù„ÙƒÙŠ ÙØ§Ø®Ø±", p:16},
                {id:38, n:"Ø¹Ø±ÙŠÙƒØ© Ù…Ø±ÙˆÙ‡", p:18}
            ],
            "Ø§Ù„Ø³Ù†Ø¯ÙˆØªØ´Ø§Øª": [
                {id:48, n:"ÙƒØ¨Ø¯Ø© Ø·Ø§Ø²Ø¬Ø©", s:{samoli:4, fatira:5}},
                {id:52, n:"Ø¨ÙŠØ¶ Ù…Ù‚Ù„ÙŠ", s:{samoli:3, fatira:4}}
            ],
            "Ø§Ù„ØªÙ…ÙŠØ³": [
                {id:56, n:"ØªÙ…ÙŠØ³ Ø¹Ø§Ø¯ÙŠ", p:1},
                {id:59, n:"ØªÙ…ÙŠØ³ Ø¬Ø¨Ù†", p:5},
                {id:66, n:"ØªÙ…ÙŠØ³ Ø¨Ø³ÙƒÙˆØª", p:3}
            ]
        };

        let cart = [];
        let currentCat = "ÙØ·ÙˆØ± Ù…Ø±ÙˆÙ‡";
        const restaurantLoc = { lat: 24.5714, lng: 46.7323 }; // Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø­ÙŠ Ø¨Ø¯Ø± Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ©

        window.onload = () => { renderTabs(); renderGrid(); checkActiveOrder(); };

        function renderTabs() {
            const h = document.getElementById('tabs');
            h.innerHTML = Object.keys(MENU).map(c => `
                <button onclick="setCat('${c}')" class="px-6 py-2 rounded-2xl whitespace-nowrap font-black transition-all ${currentCat===c?'bg-slate-900 text-white shadow-xl':'text-slate-400'}">${c}</button>
            `).join('');
        }

        function setCat(c) { currentCat = c; renderTabs(); renderGrid(); }

        function renderGrid() {
            const g = document.getElementById('grid');
            g.innerHTML = MENU[currentCat].map(i => `
                <div class="item-card p-6 flex flex-col gap-4 shadow-sm">
                    <div class="flex justify-between items-center">
                        <h3 class="font-black text-xl text-slate-800">${i.n}</h3>
                        ${i.p ? `<button onclick="add('${i.n}', ${i.p})" class="bg-blue-600 text-white px-5 py-2 rounded-xl font-black">+ ${i.p}ï·¼</button>` : '<i class="fa-solid fa-chevron-down opacity-20"></i>'}
                    </div>
                    ${i.s ? `<div class="grid grid-cols-2 gap-2">${Object.entries(i.s).map(([sz, p]) => `
                        <button onclick="add('${i.n} (${sz})', ${p})" class="bg-slate-50 p-3 rounded-xl flex justify-between items-center border border-slate-100">
                            <span class="text-[10px] font-black opacity-50 uppercase">${sz}</span>
                            <span class="font-black text-blue-700 text-sm">${p}ï·¼</span>
                        </button>`).join('')}</div>` : ''}
                </div>
            `).join('');
        }

        function add(n, p) {
            cart.push({n, p, id: Date.now()});
            updateCartUI();
            notify(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${n} Ù„Ù„Ø³Ù„Ø© ğŸ›’`, "bg-blue-600");
        }

        function updateCartUI() {
            const total = cart.reduce((s,i)=>s+i.p,0);
            const bar = document.getElementById('cartBar');
            if(cart.length > 0) {
                bar.classList.remove('translate-y-32', 'opacity-0');
                document.getElementById('cartCount').innerText = cart.length;
                document.getElementById('cartTotal').innerText = total + "ï·¼";
            } else { bar.classList.add('translate-y-32', 'opacity-0'); }
        }

        function openCart() {
            const total = cart.reduce((s,i)=>s+i.p,0);
            let h = `
                <div class="flex justify-between items-center mb-8">
                    <h2 class="text-2xl font-black text-slate-900">Ø³Ù„Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h2>
                    <button onclick="closeModal()" class="text-slate-300"><i class="fa-solid fa-xmark text-xl"></i></button>
                </div>
                <div class="space-y-4 mb-10 max-h-[300px] overflow-y-auto no-scrollbar">
                    ${cart.map((i, idx) => `
                        <div class="flex justify-between items-center bg-slate-50 p-4 rounded-2xl border border-slate-100">
                            <span class="font-black text-slate-700">${i.n}</span>
                            <div class="flex items-center gap-4">
                                <span class="font-black text-blue-600">${i.p}ï·¼</span>
                                <button onclick="remove(${idx})" class="text-red-400">âœ•</button>
                            </div>
                        </div>`).join('')}
                </div>
                <div class="bg-slate-900 p-8 rounded-[35px] text-white">
                    <div class="flex justify-between items-center mb-6">
                        <span class="opacity-60 font-bold">Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„ÙƒÙ„ÙŠ</span>
                        <span class="text-3xl font-black">${total}ï·¼</span>
                    </div>
                    <button onclick="getLocationAndSend()" class="w-full bg-blue-600 py-5 rounded-2xl font-black text-xl shadow-xl active:scale-95 transition">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ù„Ù„Ù…Ø·Ø¹Ù…</button>
                </div>`;
            showModal(h);
        }

        async function getLocationAndSend() {
            notify("â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø³Ø§ÙØ© Ù„Ù„Ù…Ø·Ø¹Ù…...", "bg-slate-700");
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(async (pos) => {
                    const dist = calculateDistance(pos.coords.latitude, pos.coords.longitude, restaurantLoc.lat, restaurantLoc.lng);
                    const orderData = {
                        items: cart,
                        total: cart.reduce((s,i)=>s+i.p,0),
                        status: 'sent',
                        distance: dist.toFixed(2) + " ÙƒÙ…",
                        time: new Date().toLocaleTimeString('ar-SA'),
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    };
                    const doc = await db.collection("orders").add(orderData);
                    localStorage.setItem('activeOrderId', doc.id);
                    notify("âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨Ùƒ Ø¨Ù†Ø¬Ø§Ø­!", "bg-green-600");
                    cart = []; updateCartUI(); closeModal(); checkActiveOrder();
                }, () => {
                    // ÙÙŠ Ø­Ø§Ù„ Ø±ÙØ¶ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ù†Ø±Ø³Ù„ Ø§Ù„Ø·Ù„Ø¨ ÙƒÙ€ "Ù…Ø­Ù„ÙŠ"
                    notify("âš ï¸ Ù„Ù… Ù†ØªÙ…ÙƒÙ† Ù…Ù† ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ØŒ Ø³ÙŠØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ ÙƒØ·Ù„Ø¨ Ù…Ø­Ù„ÙŠ", "bg-amber-600");
                    // ØªÙƒØ±Ø§Ø± Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø­ÙØ¸ Ø¨Ø¯ÙˆÙ† Ù…Ø³Ø§ÙØ©...
                });
            }
        }

        function checkActiveOrder() {
            const id = localStorage.getItem('activeOrderId');
            if(!id) return;
            db.collection("orders").doc(id).onSnapshot(doc => {
                if(!doc.exists) return;
                const o = doc.data();
                const disp = document.getElementById('activeOrderDisplay');
                disp.classList.remove('hidden');
                document.getElementById('orderIdTag').innerText = "#" + id.slice(-4);
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø®Ø·ÙˆØ§Øª
                document.getElementById('step-sent').className = o.status === 'sent' ? 'step-active flex flex-col items-center gap-1' : 'flex flex-col items-center gap-1 opacity-20';
                document.getElementById('step-preparing').className = o.status === 'preparing' ? 'step-active flex flex-col items-center gap-1' : 'flex flex-col items-center gap-1 opacity-20';
                document.getElementById('step-ready').className = o.status === 'ready' ? 'step-active flex flex-col items-center gap-1' : 'flex flex-col items-center gap-1 opacity-20';
                
                if(o.status === 'ready') notify("ğŸŠ Ø·Ù„Ø¨Ùƒ Ø¬Ø§Ù‡Ø² Ù„Ù„Ø§Ø³ØªÙ„Ø§Ù…!", "bg-green-600");
            });
        }

        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Ù‚Ø§Ù†ÙˆÙ† Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2-lat1) * Math.PI / 180;
            const dLon = (lon2-lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * Math.sin(dLon/2) * Math.sin(dLon/2);
            return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        }

        function remove(idx) { cart.splice(idx,1); updateCartUI(); if(cart.length>0) openCart(); else closeModal(); }
        function showModal(c) { document.getElementById('modalContent').innerHTML = c; document.getElementById('modal').style.display = 'flex'; setTimeout(()=>document.getElementById('modalBox').classList.remove('translate-y-full'),10); }
        function closeModal() { document.getElementById('modalBox').classList.add('translate-y-full'); setTimeout(()=>document.getElementById('modal').style.display='none',400); }
        function notify(m, c) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = m;
            document.getElementById('toastIcon').className = `w-10 h-10 rounded-2xl flex items-center justify-center text-white ${c}`;
            t.classList.remove('translate-y-[-150%]', 'opacity-0');
            setTimeout(() => t.classList.add('translate-y-[-150%]', 'opacity-0'), 3000);
        }
    </script>
</body>
</html>
